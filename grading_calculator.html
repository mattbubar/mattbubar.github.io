<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grading Calculator</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #e0f2fe; /* light blue background */
      margin: 0; padding: 0;
    }
    main {
      max-width: 700px;
      margin: 40px auto;
      padding: 20px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { margin-top: 0; text-align: center; }
    .card { margin: 20px 0; }
    label { font-size: 14px; display:block; margin-bottom:4px; }
    input[type="number"], input[type="text"], input[type="email"] {
      width: 100%; padding: 8px; border: 1px solid #d1d5db;
      border-radius: 8px; margin-bottom: 12px;
    }
    button { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; }
    .primary { background:#2563eb; color:white; }
    .ghost { background:#f3f4f6; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .muted { font-size: 12px; color:#6b7280; }
    table { width:100%; border-collapse:collapse; margin-top:16px; }
    th,td { padding:8px; border-bottom:1px solid #e5e7eb; font-size:14px; }
    th { text-align:left; background:#f9fafb; }
    .right { text-align:right; }
  </style>
</head>
<body>
  <main>
    <h1>Grading Calculator</h1>

    <!-- Sign-in -->
    <div id="step-send" class="card">
      <label>Email</label>
      <input id="email" type="email" placeholder="you@example.com" />
      <button class="primary" id="sendLink">Send magic link</button>
      <span class="muted" id="sendStatus"></span>
    </div>
    <div id="step-complete" class="card hidden">
      <p>Finishing sign-in…</p>
      <div id="needEmail" class="hidden">
        <input id="confirmEmail" type="email" placeholder="Confirm your email" />
        <button class="primary" id="finishWithEmail">Finish</button>
        <span id="finishStatus" class="muted"></span>
      </div>
    </div>
    <div id="authed" class="card hidden">
      Signed in as <strong id="who"></strong>
      <button id="signOut" class="ghost">Sign out</button>
    </div>

    <!-- Calculator (hidden until auth) -->
    <div id="app" class="hidden">
      <div class="card">
        <label>Card name</label>
        <input id="cardName" type="text" placeholder="1991 SkyBox #546 MJ" />
        <label>Raw cost ($)</label>
        <input id="rawCost" type="number" value="12" />
        <label>Grading fee ($)</label>
        <input id="gradeFee" type="number" value="19" />
        <label>PSA 10 sale price ($)</label>
        <input id="price10" type="number" value="120" />
        <label>PSA 9 sale price ($)</label>
        <input id="price9" type="number" value="35" />
        <label>Gem rate (%)</label>
        <input id="gemRate" type="number" value="60" />
        <label>eBay fee (%)</label>
        <input id="feePct" type="number" value="12.5" />
        <label>Other costs ($)</label>
        <input id="otherCost" type="number" value="0" />

        <button class="primary" id="calcBtn">Calculate</button>
        <button class="ghost" id="saveBtn" disabled>Save</button>
        <span id="calcStatus" class="muted"></span>
      </div>

      <div class="card">
        <p>EV: <strong id="evOut">$0.00</strong></p>
        <p>Profit if PSA10: <strong id="p10Out">$0.00</strong></p>
        <p>Profit if PSA9: <strong id="p9Out">$0.00</strong></p>
        <p>Net Cost: <strong id="netCostOut">$0.00</strong></p>
        <p>Total EV: <strong id="totalEvOut">$0.00</strong></p>
      </div>

      <div class="card">
        <h3>Saved</h3>
        <span id="saveStatus" class="muted"></span>
        <table>
          <thead>
            <tr><th>When</th><th>Card</th><th class="right">EV</th><th class="right">P10</th><th class="right">P9</th><th class="right">Net</th><th></th></tr>
          </thead>
          <tbody id="cardsTbody"></tbody>
        </table>
      </div>
    </div>
  </main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  initializeAuth, onAuthStateChanged, signOut, setPersistence,
  browserLocalPersistence, browserPopupRedirectResolver,
  isSignInWithEmailLink, sendSignInLinkToEmail, signInWithEmailLink
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  initializeFirestore, collection, addDoc, serverTimestamp, onSnapshot,
  query, orderBy, doc, deleteDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBvUBx-QTjTyzv8oWxoCX4rweq72yChS3M",
  authDomain: "grading-calculator-ce36f.firebaseapp.com",
  projectId: "grading-calculator-ce36f",
  messagingSenderId: "406763572625",
  appId: "1:406763572625:web:026a965c194d9a3c8cde30",
};
const app = initializeApp(firebaseConfig);
const auth = initializeAuth(app, { persistence: browserLocalPersistence, popupRedirectResolver: browserPopupRedirectResolver });
const db = initializeFirestore(app, {});

const $ = id=>document.getElementById(id);
const show=(id,yes=true)=>$(id).classList.toggle("hidden",!yes);
const setText=(id,t)=>$(id).textContent=t??"";
const fmt=n=>isFinite(n)?n.toLocaleString(undefined,{style:'currency',currency:'USD'}):"—";

// === Auth ===
const actionCodeSettings={url:window.location.href,handleCodeInApp:true};
$("sendLink").onclick=async()=>{
  const email=$("email").value.trim();
  if(!email)return setText("sendStatus","Enter email");
  await sendSignInLinkToEmail(auth,email,actionCodeSettings);
  localStorage.setItem("emailForSignIn",email);
  setText("sendStatus","Link sent!");
};
async function finishSignIn(email){
  await signInWithEmailLink(auth,email,window.location.href);
  localStorage.removeItem("emailForSignIn");
  history.replaceState({},document.title,window.location.pathname);
}
if(isSignInWithEmailLink(auth,window.location.href)){
  const email=localStorage.getItem("emailForSignIn");
  if(email) finishSignIn(email); else show("needEmail",true);
}
$("finishWithEmail").onclick=()=>finishSignIn($("confirmEmail").value.trim());
onAuthStateChanged(auth,user=>{
  if(user){
    show("step-send",false); show("step-complete",false);
    show("authed",true); show("app",true);
    setText("who",user.email);
    const q=query(collection(db,`users/${user.uid}/cards`),orderBy("createdAt","desc"));
    onSnapshot(q,snap=>renderCards(snap));
  } else {
    show("app",false); show("authed",false); show("step-send",true);
  }
});
$("signOut").onclick=()=>signOut(auth);

// === Calculator ===
function readInputs(){
  return{
    cardName:$("#cardName").value.trim(),
    rawCost:parseFloat($("#rawCost").value)||0,
    gradeFee:parseFloat($("#gradeFee").value)||0,
    price10:parseFloat($("#price10").value)||0,
    price9:parseFloat($("#price9").value)||0,
    gemRate:(parseFloat($("#gemRate").value)||0)/100,
    feePct:(parseFloat($("#feePct").value)||0)/100,
    otherCost:parseFloat($("#otherCost").value)||0,
  };
}
function compute(v){
  const netCost=v.rawCost+v.gradeFee+v.otherCost;
  const net10=v.price10*(1-v.feePct)-netCost;
  const net9=v.price9*(1-v.feePct)-netCost;
  const ev=v.gemRate*net10+(1-v.gemRate)*net9;
  return{ev,profit10:net10,profit9:net9,netCost,totalEV:ev};
}
$("calcBtn").onclick=()=>{
  const v=readInputs(),c=compute(v);
  setText("evOut",fmt(c.ev)); setText("p10Out",fmt(c.profit10));
  setText("p9Out",fmt(c.profit9)); setText("netCostOut",fmt(c.netCost));
  setText("totalEvOut",fmt(c.totalEV));
  window.__last={v,c}; $("saveBtn").disabled=false;
};
$("saveBtn").onclick=async()=>{
  const u=auth.currentUser;if(!u||!window.__last)return;
  const {v,c}=window.__last;
  await addDoc(collection(db,`users/${u.uid}/cards`),{
    cardName:v.cardName, rawCost:v.rawCost, gradeFee:v.gradeFee, price10:v.price10,
    price9:v.price9, gemRate:v.gemRate, feePct:v.feePct, otherCost:v.otherCost,
    ev:c.ev, profit10:c.profit10, profit9:c.profit9, netCost:c.netCost, createdAt:serverTimestamp()
  });
  setText("saveStatus","Saved!"); setTimeout(()=>setText("saveStatus",""),1500);
};

// === Render saved list ===
function renderCards(snap){
  const tbody=$("cardsTbody"); tbody.innerHTML="";
  snap.forEach(docSnap=>{
    const d=docSnap.data();
    const tr=document.createElement("tr");
    const when=d.createdAt?.toDate?d.createdAt.toDate().toLocaleString():"";
    tr.innerHTML=`
      <td>${when}</td><td>${d.cardName||""}</td>
      <td class="right">${fmt(d.ev)}</td>
      <td class="right">${fmt(d.profit10)}</td>
      <td class="right">${fmt(d.profit9)}</td>
      <td class="right">${fmt(d.netCost)}</td>
      <td><button class="ghost" data-id="${docSnap.id}">Del</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll("button[data-id]").forEach(btn=>{
    btn.onclick=()=>deleteDoc(doc(db,`users/${auth.currentUser.uid}/cards/${btn.dataset.id}`));
  });
}
</script>
</body>
</html>
