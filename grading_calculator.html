<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Magic Link Sign-In</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; max-width: 520px; margin: 24px auto; padding: 0 16px; }
    .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 18px; box-shadow: 0 1px 3px rgba(0,0,0,.05); }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; }
    button.primary { background: black; color: white; }
    input[type="email"] { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; margin: 8px 0 12px; }
    .muted { color: #6b7280; font-size: 12px; }
    .row { display: flex; gap: 8px; align-items: center; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Sign in to Grading Calculator</h1>

  <div class="card" id="step-send">
    <label for="email">Email</label>
    <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />
    <div class="row">
      <button class="primary" id="sendLink">Send magic link</button>
      <span class="muted" id="sendStatus"></span>
    </div>
    <p class="muted">We’ll email you a one-tap sign-in link. No password needed.</p>
  </div>

  <div class="card hidden" id="step-complete">
    <p>Finishing sign-in…</p>
    <div id="needEmail" class="hidden">
      <p class="muted">For security, confirm your email to complete sign-in:</p>
      <input id="confirmEmail" type="email" placeholder="you@example.com" autocomplete="email" />
      <div class="row">
        <button class="primary" id="finishWithEmail">Finish sign-in</button>
        <span class="muted" id="finishStatus"></span>
      </div>
    </div>
  </div>

  <div class="card hidden" id="authed">
    <p>Signed in as <strong id="who"></strong></p>
    <div class="row">
      <button id="signOut">Sign out</button>
      <span class="muted" id="authStatus"></span>
    </div>
  </div>

  <div id="debug" class="muted" style="margin-top:12px;"></div>

  <script type="module">
    // --- Firebase v11 (CDN) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      initializeAuth,
      onAuthStateChanged,
      signOut,
      setPersistence,
      browserLocalPersistence,
      browserPopupRedirectResolver,
      isSignInWithEmailLink,
      sendSignInLinkToEmail,
      signInWithEmailLink
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // --- Your Firebase config (replace with yours) ---
	// Import the functions you need from the SDKs you need
	import { initializeApp } from "firebase/app";
	import { getAnalytics } from "firebase/analytics";
	// TODO: Add SDKs for Firebase products that you want to use
	// https://firebase.google.com/docs/web/setup#available-libraries

	// Your web app's Firebase configuration
	// For Firebase JS SDK v7.20.0 and later, measurementId is optional
	const firebaseConfig = {
	  apiKey: "AIzaSyBvUBx-QTjTyzv8oWxoCX4rweq72yChS3M",
	  authDomain: "grading-calculator-ce36f.firebaseapp.com",
	  projectId: "grading-calculator-ce36f",
	  storageBucket: "grading-calculator-ce36f.firebasestorage.app",
	  messagingSenderId: "406763572625",
	  appId: "1:406763572625:web:026a965c194d9a3c8cde30",
	  measurementId: "G-GRKKZPC8VV"
	};

	// Initialize Firebase
	const app = initializeApp(firebaseConfig);
	const analytics = getAnalytics(app);

    // --- Init ---
    const app = initializeApp(firebaseConfig);
    const auth = initializeAuth(app, {
      persistence: browserLocalPersistence,
      popupRedirectResolver: browserPopupRedirectResolver
    });

    // --- UI helpers ---
    const $ = (id) => document.getElementById(id);
    const show = (id, yes = true) => $(id).classList.toggle("hidden", !yes);
    const setText = (id, text) => $(id).textContent = text ?? "";

    // --- ActionCodeSettings for Email Link ---
    // Use your production URL. Keep same-origin so the link opens back in your app.
    const actionCodeSettings = {
      url: `${window.location.origin}${window.location.pathname}`, // return here
      handleCodeInApp: true,
      // If you have a custom Auth domain (recommended), it will be used automatically.
      // dynamicLinkDomain: "yourcustom.page.link" // optional if you’ve set one in Firebase Auth
    };

    // --- Send magic link ---
    $("sendLink").addEventListener("click", async () => {
      const email = $("email").value.trim();
      setText("sendStatus", "");
      if (!email) { setText("sendStatus", "Enter a valid email."); return; }

      try {
        await setPersistence(auth, browserLocalPersistence);
        await sendSignInLinkToEmail(auth, email, actionCodeSettings);
        // Save email locally so we can auto-complete on same device
        window.localStorage.setItem("emailForSignIn", email);
        setText("sendStatus", "Link sent! Check your email.");
      } catch (err) {
        console.error(err);
        setText("sendStatus", err.message || "Could not send link.");
      }
    });

    // --- Complete sign-in if this page is opened via the link ---
    async function tryCompleteSignIn() {
      try {
        if (!isSignInWithEmailLink(auth, window.location.href)) return;

        show("step-send", false);
        show("step-complete", true);

        let email = window.localStorage.getItem("emailForSignIn");
        if (!email) {
          // Opened on a different device/browser: ask user to re-enter email.
          show("needEmail", true);
          return;
        }

        await finishSignIn(email);
      } catch (err) {
        console.error(err);
        setText("finishStatus", err.message || "Sign-in failed.");
      }
    }

    async function finishSignIn(email) {
      setText("finishStatus", "Signing you in…");
      try {
        await setPersistence(auth, browserLocalPersistence);
        await signInWithEmailLink(auth, email, window.location.href);
        window.localStorage.removeItem("emailForSignIn");
        setText("finishStatus", "");
        // Clean the URL (remove oobCode/etc)
        window.history.replaceState({}, document.title, window.location.pathname);
      } catch (err) {
        console.error(err);
        setText("finishStatus", err.message || "Could not complete sign-in.");
      }
    }

    $("finishWithEmail").addEventListener("click", async () => {
      const email = $("confirmEmail").value.trim();
      if (!email) { setText("finishStatus", "Enter your email."); return; }
      await finishSignIn(email);
    });

    // --- Auth state listener ---
    onAuthStateChanged(auth, (user) => {
      if (user) {
        show("step-send", false);
        show("step-complete", false);
        show("authed", true);
        setText("who", user.email || user.uid);
      } else {
        show("authed", false);
        show("step-send", true);
      }
    });

    // --- Sign out ---
    $("signOut").addEventListener("click", async () => {
      setText("authStatus", "");
      try {
        await signOut(auth);
        setText("authStatus", "Signed out.");
      } catch (err) {
        console.error(err);
        setText("authStatus", err.message || "Error signing out.");
      }
    });

    // Try to complete sign-in on load (when returning from email link)
    tryCompleteSignIn();
  </script>
</body>
</html>
