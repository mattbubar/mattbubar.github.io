<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Card Grading Calculator + Firebase (Email Link + Edit/Delete)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0f172a;color:#e5e7eb;margin:0;padding:24px}
    .wrap{max-width:980px;margin:0 auto}
    .card{background:#0b1220;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px;margin-bottom:16px}
    .grid{display:grid;gap:10px}
    @media(min-width:760px){.grid{grid-template-columns:repeat(3,1fr)}}
    label{font-size:12px;color:#94a3b8;margin-bottom:4px;display:block}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0a0f1e;color:#e5e7eb;font-size:14px}
    button{padding:10px 12px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:600;cursor:pointer}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .btn-secondary{background:#334155}
    .btn-danger{background:#dc2626}
    .stat{display:flex;justify-content:space-between;padding:10px;border:1px solid rgba(255,255,255,.08);border-radius:10px;background:#0a0f1e;margin-top:8px}
    .pill{padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .good{background:rgba(22,163,74,.15);color:#86efac;border:1px solid rgba(22,163,74,.3)}
    .bad{background:rgba(220,38,38,.15);color:#fecaca;border:1px solid rgba(220,38,38,.3)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left;font-size:14px;vertical-align:middle}
    th{color:#94a3b8;font-weight:600}
    .small{font-size:12px;color:#94a3b8}
    .actions{display:flex;gap:8px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:#94a3b8;font-size:12px}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Card Grading Profit & EV Calculator (Email Link + Firebase Edit/Delete)</h2>

    <!-- ===== Sign-in (Email Link) ===== -->
    <div class="card" id="signinCard">
      <div class="row" style="justify-content:space-between;">
        <div>
          <label>Email (passwordless)</label>
          <input id="email" type="email" placeholder="you@example.com" autocomplete="email"/>
        </div>
        <div class="row">
          <button id="sendLink">Send magic link</button>
          <span id="sendStatus" class="muted"></span>
        </div>
      </div>

      <div id="step-complete" class="hidden" style="margin-top:8px">
        <div id="needEmail" class="hidden">
          <label>Confirm your email</label>
          <input id="confirmEmail" type="email" placeholder="you@example.com" autocomplete="email"/>
          <button id="finishWithEmail">Finish sign-in</button>
          <span id="finishStatus" class="muted"></span>
        </div>
      </div>

      <div id="authed" class="hidden" style="margin-top:8px">
        <div class="row" style="justify-content:space-between;">
          <div>Signed in as <strong id="who"></strong></div>
          <div class="row">
            <button id="signOut" class="btn-secondary">Sign out</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Calculator (hidden until auth) ===== -->
    <div id="app" class="hidden">
      <!-- Calculator -->
      <div class="card">
        <div class="grid">
          <div><label>Card Name</label><input id="cardName" placeholder="e.g., 1991 SkyBox #546 MJ"/></div>
          <div><label>Raw Price ($)</label><input id="rawPrice" type="number" inputmode="decimal" value="20"/></div>
          <div><label>Grading Fee ($)</label><input id="gradingFee" type="number" inputmode="decimal" value="21"/></div>
          <div><label>PSA 9 Price ($)</label><input id="psa9Price" type="number" inputmode="decimal" value="25"/></div>
          <div><label>PSA 10 Price ($)</label><input id="psa10Price" type="number" inputmode="decimal" value="100"/></div>
          <div><label>eBay Fee (%)</label><input id="ebayFee" type="number" inputmode="decimal" value="12.5"/></div>
          <div><label>Gem Rate (%)</label><input id="gemRate" type="number" inputmode="decimal" value="60"/></div>
        </div>

        <div class="btns">
          <button id="calcBtn">Calculate</button>
          <button id="saveBtn">Save Card to Firebase</button>
          <button id="updateBtn" class="btn-secondary" style="display:none">Update Card</button>
          <button id="cancelEditBtn" class="btn-secondary" style="display:none">Cancel Edit</button>
          <span id="calcStatus" class="muted"></span>
        </div>

        <div id="results" style="margin-top:8px;display:none">
          <div class="stat"><span>Total Cost (Raw + Grading)</span><b id="r_cost"></b></div>
          <div class="stat"><span>PSA 9 Net (after fees)</span><span><b id="r_net9"></b> <span id="r_pill9" class="pill"></span></span></div>
          <div class="stat"><span>PSA 10 Net (after fees)</span><span><b id="r_net10"></b> <span id="r_pill10" class="pill"></span></span></div>
          <div class="stat"><span>PSA 9 Profit/Loss</span><span id="r_p9"></span></div>
          <div class="stat"><span>PSA 10 Profit/Loss</span><span id="r_p10"></span></div>
          <div class="stat"><span>Expected Profit (Gem% × P10 + (1−Gem%) × P9)</span><span id="r_ev"></span></div>
          <div class="stat"><span>Decision</span><b id="r_decision" class="pill"></b></div>
          <div class="small">Decision rule: <b>YES</b> if Gem Rate ≥ 60% and EV ≥ $0.</div>
        </div>
      </div>

      <!-- Live list (per-user) -->
      <div class="card">
        <h3 style="margin:4px 0 8px">Saved Cards (Live)</h3>
        <table>
          <thead>
            <tr>
              <th>Card</th><th>Raw</th><th>9</th><th>10</th><th>Gem%</th><th>EV</th><th>Decision</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="cardsTbody"></tbody>
        </table>
        <div class="small">Data is stored under your account at <code>users/{uid}/cards</code>.</div>
      </div>
    </div>
  </div>

  <!-- Firebase (module style) -->
  <script type="module">
    // Core Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";

    // Auth (Email Link)
    import {
      initializeAuth, onAuthStateChanged, signOut, setPersistence,
      browserLocalPersistence, browserPopupRedirectResolver,
      isSignInWithEmailLink, sendSignInLinkToEmail, signInWithEmailLink
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // Firestore
    import {
      getFirestore, collection, addDoc, serverTimestamp, onSnapshot,
      query, orderBy, doc, deleteDoc, updateDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ==== Your Firebase config (project: grading-calculator-ce36f) ====
    const firebaseConfig = {
      apiKey: "AIzaSyBvUBx-QTjTyzv8oWxoCX4rweq72yChS3M",
      authDomain: "grading-calculator-ce36f.firebaseapp.com",
      projectId: "grading-calculator-ce36f",
      messagingSenderId: "406763572625",
      appId: "1:406763572625:web:026a965c194d9a3c8cde30"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = initializeAuth(app, {
      persistence: browserLocalPersistence,
      popupRedirectResolver: browserPopupRedirectResolver
    });
    const db = getFirestore(app);

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);
    const money = (v) => "$" + (Number(v)||0).toFixed(2);
    const pill = (el, ok) => { el.className = "pill " + (ok ? "good" : "bad"); el.textContent = ok ? "PROFIT" : "LOSS"; };
    const show = (id, yes=true) => $(id).classList.toggle("hidden", !yes);
    let editingId = null; // doc id being edited
    let userCardsRef = null; // per-user collection ref
    let unsubList = null;

    // ===== Email Link Auth =====
    const actionCodeSettings = {
      url: `${window.location.origin}${window.location.pathname}`,
      handleCodeInApp: true
    };

    $("sendLink").addEventListener("click", async () => {
      const email = $("email").value.trim();
      $("sendStatus").textContent = "";
      if (!email) { $("sendStatus").textContent = "Enter a valid email."; return; }
      try {
        await setPersistence(auth, browserLocalPersistence);
        await sendSignInLinkToEmail(auth, email, actionCodeSettings);
        localStorage.setItem("emailForSignIn", email);
        $("sendStatus").textContent = "Link sent! Check your email.";
      } catch (err) {
        console.error(err);
        $("sendStatus").textContent = err.message || "Could not send link.";
      }
    });

    async function finishSignIn(email) {
      $("finishStatus").textContent = "Signing you in…";
      try {
        await setPersistence(auth, browserLocalPersistence);
        await signInWithEmailLink(auth, email, window.location.href);
        localStorage.removeItem("emailForSignIn");
        $("finishStatus").textContent = "";
        // Clean URL
        history.replaceState({}, document.title, window.location.pathname);
      } catch (err) {
        console.error(err);
        $("finishStatus").textContent = err.message || "Could not complete sign-in.";
      }
    }

    if (isSignInWithEmailLink(auth, window.location.href)) {
      show("step-complete", true);
      const email = localStorage.getItem("emailForSignIn");
      if (email) {
        await finishSignIn(email);
      } else {
        show("needEmail", true);
        $("finishWithEmail").addEventListener("click", async () => {
          const em = $("confirmEmail").value.trim();
          if (!em) { $("finishStatus").textContent = "Enter your email."; return; }
          await finishSignIn(em);
        });
      }
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        // UI show app
        show("authed", true);
        show("signinCard", true);
        show("app", true);
        $("who").textContent = user.email || user.uid;

        // Set per-user collection and subscribe
        userCardsRef = collection(db, `users/${user.uid}/cards`);
        if (unsubList) unsubList();
        unsubList = onSnapshot(query(userCardsRef, orderBy("createdAt","desc")), renderList);
      } else {
        show("authed", false);
        show("app", false);
        show("signinCard", true);
        if (unsubList) { unsubList(); unsubList = null; }
        $("cardsTbody").innerHTML = "";
      }
    });

    $("signOut").addEventListener("click", async () => {
      try { await signOut(auth); } catch (e) { console.error(e); }
    });

    // ===== Calculator logic =====
    function calc() {
      const raw = parseFloat($("rawPrice").value)||0;
      const grade = parseFloat($("gradingFee").value)||0;
      const p9 = parseFloat($("psa9Price").value)||0;
      const p10 = parseFloat($("psa10Price").value)||0;
      const fee = (parseFloat($("ebayFee").value)||0)/100;
      const gem = (parseFloat($("gemRate").value)||0)/100;

      const cost = raw + grade;
      const net9 = p9 * (1 - fee);
      const net10 = p10 * (1 - fee);
      const profit9 = net9 - cost;
      const profit10 = net10 - cost;
      const ev = gem * profit10 + (1 - gem) * profit9;
      const pass = gem >= 0.60 && ev >= 0;

      $("results").style.display = "block";
      $("r_cost").textContent = money(cost);
      $("r_net9").textContent = money(net9);
      $("r_net10").textContent = money(net10);
      pill($("r_pill9"), profit9 >= 0);
      pill($("r_pill10"), profit10 >= 0);
      $("r_p9").innerHTML = (profit9>=0?'<span class="pill good">+</span> ':'<span class="pill bad">−</span> ')+ money(Math.abs(profit9));
      $("r_p10").innerHTML = (profit10>=0?'<span class="pill good">+</span> ':'<span class="pill bad">−</span> ')+ money(Math.abs(profit10));
      $("r_ev").innerHTML = (ev>=0?'<span class="pill good">+</span> ':'<span class="pill bad">−</span> ')+ money(Math.abs(ev));
      $("r_decision").className = "pill " + (pass ? "good" : "bad");
      $("r_decision").textContent = pass ? "YES (Grade)" : "NO (Skip)";

      return { raw, grade, p9, p10, feePct: fee, gemPct: gem, cost, net9, net10, profit9, profit10, ev, pass };
    }

    $("calcBtn").addEventListener("click", () => {
      calc();
      $("calcStatus").textContent = "Calculated.";
      setTimeout(()=>$("calcStatus").textContent="",1200);
    });

    // ===== Save / Update =====
    $("saveBtn").addEventListener("click", async () => {
      const u = auth.currentUser;
      if (!u) { alert("Sign in first."); return; }
      const name = $("cardName").value.trim();
      if (!name) { alert("Please enter a Card Name."); return; }
      const r = calc();
      try {
        await addDoc(userCardsRef, {
          name,
          raw: r.raw, gradingFee: r.grade, psa9: r.p9, psa10: r.p10,
          ebayFeePct: r.feePct, gemRatePct: r.gemPct,
          cost: r.cost, net9: r.net9, net10: r.net10,
          profit9: r.profit9, profit10: r.profit10, ev: r.ev,
          decision: r.pass ? "YES" : "NO",
          createdAt: serverTimestamp()
        });
        $("calcStatus").textContent = "Saved ✅";
        setTimeout(()=>$("calcStatus").textContent="",1200);
        clearEditing();
      } catch (e) {
        console.error(e);
        alert(e.message || "Save failed.");
      }
    });

    $("updateBtn").addEventListener("click", updateExisting);
    $("cancelEditBtn").addEventListener("click", clearEditing);

    async function updateExisting() {
      const u = auth.currentUser;
      if (!u || !editingId) return;
      const r = calc();
      const name = $("cardName").value.trim();
      try {
        await updateDoc(doc(db, `users/${u.uid}/cards/${editingId}`), {
          name,
          raw: r.raw, gradingFee: r.grade, psa9: r.p9, psa10: r.p10,
          ebayFeePct: r.feePct, gemRatePct: r.gemPct,
          cost: r.cost, net9: r.net9, net10: r.net10,
          profit9: r.profit9, profit10: r.profit10, ev: r.ev,
          decision: r.pass ? "YES" : "NO"
        });
        $("calcStatus").textContent = "Updated ✅";
        setTimeout(()=>$("calcStatus").textContent="",1200);
        clearEditing();
      } catch (e) {
        console.error(e);
        alert(e.message || "Update failed.");
      }
    }

    function enterEdit(docId, data) {
      editingId = docId;
      $("cardName").value = data.name || "";
      $("rawPrice").value = data.raw ?? "";
      $("gradingFee").value = data.gradingFee ?? "";
      $("psa9Price").value = data.psa9 ?? "";
      $("psa10Price").value = data.psa10 ?? "";
      $("ebayFee").value = data.ebayFeePct ? (data.ebayFeePct*100).toFixed(2) : "12.5";
      $("gemRate").value = data.gemRatePct ? (data.gemRatePct*100).toFixed(0) : "60";
      calc();

      $("saveBtn").style.display = "none";
      $("updateBtn").style.display = "inline-block";
      $("cancelEditBtn").style.display = "inline-block";
    }

    function clearEditing() {
      editingId = null;
      $("saveBtn").style.display = "inline-block";
      $("updateBtn").style.display = "none";
      $("cancelEditBtn").style.display = "none";
    }

    // ===== Live list (per-user) =====
    const tbody = $("cardsTbody");

    function renderList(snap) {
      tbody.innerHTML = "";
      snap.forEach(docSnap => {
        const c = docSnap.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.name || ""}</td>
          <td>${money(c.raw)}</td>
          <td>${money(c.psa9)}</td>
          <td>${money(c.psa10)}</td>
          <td>${Math.round((c.gemRatePct||0)*100)}%</td>
          <td>${money(c.ev || 0)}</td>
          <td><span class="pill ${c.decision==='YES'?'good':'bad'}">${c.decision||'NO'}</span></td>
          <td class="actions">
            <button class="btn-secondary" data-action="edit" data-id="${docSnap.id}">Edit</button>
            <button class="btn-danger" data-action="delete" data-id="${docSnap.id}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    tbody.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");
      const u = auth.currentUser;
      if (!u) return;

      if (action === "delete") {
        if (confirm("Delete this card?")) {
          try { await deleteDoc(doc(db, `users/${u.uid}/cards/${id}`)); }
          catch (err) { console.error(err); alert(err.message || "Delete failed."); }
        }
      } else if (action === "edit") {
        try {
          const snap = await getDoc(doc(db, `users/${u.uid}/cards/${id}`));
          if (snap.exists()) enterEdit(id, snap.data());
        } catch (err) {
          console.error(err);
          alert(err.message || "Could not load document for edit.");
        }
      }
    });

    // Auto-calc once
    window.addEventListener("DOMContentLoaded", calc);
  </script>
</body>
</html>
