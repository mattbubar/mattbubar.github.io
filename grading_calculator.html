<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Card Grading Calculator + Firebase (Modern)</title>
  <style>
    /* ===== Base tokens ===== */
    :root{
      --bg:#0f172a; --card:#0b1220; --card2:#0a0f1e; --border:rgba(255,255,255,.08);
      --muted:#94a3b8; --text:#e5e7eb; --btn:#2563eb; --btn2:#334155; --danger:#dc2626;
      --good-bg:rgba(22,163,74,.15); --good-bd:rgba(22,163,74,.3); --good-tx:#86efac;
      --bad-bg:rgba(220,38,38,.15); --bad-bd:rgba(220,38,38,.3);

      /* Modern polish */
      --radius-sm:10px; --radius-md:14px; --radius-lg:20px;
      --shadow-1:0 1px 2px rgba(0,0,0,.12), 0 8px 20px rgba(0,0,0,.18);
      --shadow-0:0 1px 1px rgba(0,0,0,.06);
      --hairline: color-mix(in oklab, var(--text) 12%, transparent);
      --focus-ring: 0 0 0 2px color-mix(in oklab, var(--btn) 35%, transparent);
    }

    /* ===== Theme palettes from your images ===== */
    body.theme-dentakay { --bg:#13261F; --card:#235945; --card2:#2F735A; --border:rgba(241,242,240,.12); --muted:#F1F2F0; --text:#F1F2F0; --btn:#2F735A; --btn2:#235945; --danger:#F1F2F0; --good-bg:rgba(47,115,90,.25); --good-bd:rgba(47,115,90,.5); --good-tx:#13261F; --bad-bg:rgba(13,13,13,.20); --bad-bd:rgba(13,13,13,.35) }
    body.theme-logofolio { --bg:#364959; --card:#435C73; --card2:#4478A6; --border:rgba(150,185,217,.18); --muted:#96B9D9; --text:#E8F1FA; --btn:#5684BF; --btn2:#4478A6; --danger:#8B2C2C; --good-bg:rgba(86,132,191,.22); --good-bd:rgba(86,132,191,.42); --good-tx:#0d1b2a; --bad-bg:rgba(139,44,44,.18); --bad-bd:rgba(139,44,44,.38) }
    body.theme-forest { --bg:#232625; --card:#35403A; --card2:#4C594F; --border:rgba(191,191,184,.16); --muted:#BFBFB8; --text:#EDEDEA; --btn:#A4A69C; --btn2:#4C594F; --danger:#C94040; --good-bg:rgba(164,166,156,.20); --good-bd:rgba(164,166,156,.40); --good-tx:#222; --bad-bg:rgba(201,64,64,.18); --bad-bd:rgba(201,64,64,.36) }
    body.theme-nissan { --bg:#F2F2F2; --card:#C4E5F2; --card2:#AED8F2; --border:rgba(13,13,13,.12); --muted:#404040; --text:#0D0D0D; --btn:#404040; --btn2:#0D0D0D; --danger:#9A1B1B; --good-bg:rgba(64,64,64,.10); --good-bd:rgba(64,64,64,.28); --good-tx:#0D0D0D; --bad-bg:rgba(154,27,27,.10); --bad-bd:rgba(154,27,27,.30) }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text);margin:0;padding:16px;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .wrap{max-width:980px;margin:0 auto}
    h2{margin:0 0 12px;font-size:22px;line-height:1.2}

    /* Cards */
    .card{
      background: linear-gradient(180deg, color-mix(in oklab, var(--card) 92%, transparent), var(--card));
      border:1px solid var(--hairline);
      border-radius:var(--radius-md);
      padding:12px;
      margin-bottom:12px;
      box-shadow:var(--shadow-0);
    }

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:12px}
    .hidden{display:none}

    /* Inputs */
    label{font-size:12px;color:var(--muted);margin-bottom:4px;display:block}
    input,select{
      width:100%;padding:12px;border-radius:var(--radius-md);
      border:1px solid var(--hairline); background:color-mix(in oklab, var(--card2) 92%, transparent);
      color:var(--text); font-size:16px; line-height:1.3; transition:background .2s, border-color .2s, box-shadow .2s;
    }
    input::placeholder{color: color-mix(in oklab, var(--muted) 70%, transparent)}
    input:focus,select:focus{outline:none; box-shadow:var(--focus-ring); border-color: color-mix(in oklab, var(--btn) 45%, var(--hairline))}

    /* Buttons */
    button{
      padding:12px 14px; border:0; border-radius:var(--radius-md); background:var(--btn); color:#fff;
      font-weight:600; cursor:pointer; font-size:16px; line-height:1.3; min-height:44px;
      box-shadow:0 1px 0 rgba(255,255,255,.06) inset; transition: transform .08s, box-shadow .2s, background .2s;
    }
    button:hover{ transform: translateY(-1px); box-shadow: var(--shadow-1) }
    button:active{ transform: translateY(0); box-shadow: var(--shadow-0) }
    button:disabled{opacity:.6; cursor:not-allowed}
    .btn-secondary{ background:transparent; color:var(--text); border:1px solid var(--hairline) }
    .btn-danger{ background:var(--danger) }

    /* Top bar (compact) */
    .compact *{font-size:13px}
    .compact select,.compact input{padding:8px 10px;border-radius:10px}
    .compact button{padding:8px 10px;border-radius:10px;min-height:0}
    .topbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:space-between}
    .topbar .group{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .email-wrap input{width:220px}
    @media(max-width:760px){.email-wrap input{width:180px}}

    /* Theme chips */
    .theme-chip{
      display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--hairline);
      border-radius:999px;background:transparent;cursor:pointer;color:var(--text)
    }
    .theme-chip[aria-pressed="true"]{ background: color-mix(in oklab, var(--btn) 18%, transparent) }

    /* Mini-auth chip */
    .mini-auth{display:flex;align-items:center;gap:8px}
    .mini-auth .email-chip{display:inline-flex;align-items:center;gap:6px;background:var(--card2);border:1px solid var(--hairline);border-radius:999px;padding:6px 10px;font-weight:600;white-space:nowrap;max-width:220px;overflow:hidden;text-overflow:ellipsis}
    .mini-auth button{padding:6px 8px;border-radius:999px;min-height:0}
    .mini-auth .dot{width:6px;height:6px;border-radius:999px;background:var(--btn)}

    /* Grid + buttons area */
    .grid{display:grid;gap:10px}
    @media(min-width:760px){.grid{grid-template-columns:repeat(3,1fr)}}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    @media(max-width:759px){.btns button{flex:1 1 48%}}

    /* Stats pills */
    .stat{display:flex;justify-content:space-between;gap:8px;padding:12px;border:1px solid var(--hairline);border-radius:var(--radius-md);background:color-mix(in oklab, var(--card2) 95%, transparent);margin-top:8px;font-size:14px}
    .pill{padding:3px 10px;border-radius:999px;border:1px solid var(--hairline);font-size:12px;font-weight:700;vertical-align:middle}
    .good{background: color-mix(in oklab, var(--good-bg) 100%, transparent); color: var(--good-tx)}
    .bad{ background: color-mix(in oklab, var(--bad-bg) 100%, transparent); color:#fecaca }

    /* Table */
    .table-wrap{overflow:auto;-webkit-overflow-scrolling:touch;border-radius:10px}
    table{width:100%;border-collapse:collapse;min-width:760px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left;font-size:14px;vertical-align:middle}
    th{color:var(--muted);font-weight:600;background:rgba(255,255,255,.02);position:sticky;top:0;backdrop-filter:saturate(1.2) blur(2px)}
    tbody tr:nth-child(even) td{ background: rgba(255,255,255,.02) }
    tbody tr:hover td{ background: rgba(255,255,255,.04) }
    .actions button{ padding:6px 8px; border-radius:10px }

    /* Sticky filter/search card */
    .sticky{ position: sticky; top: 8px; z-index: 2 }

    /* Skeleton loader */
    .skeleton{ position:relative; overflow:hidden; background: rgba(255,255,255,.06); border-radius:6px; height:14px }
    .shimmer{
      position:absolute; inset:0; transform:translateX(-100%);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.15), transparent);
      animation: shimmer 1.3s infinite;
    }
    @keyframes shimmer { 100% { transform: translateX(100%); } }

    /* Toasts */
    .toast-wrap{ position: fixed; top: 16px; right: 16px; display:flex; flex-direction:column; gap:8px; z-index: 9999 }
    .toast{
      background: color-mix(in oklab, var(--card2) 95%, transparent);
      color: var(--text); border:1px solid var(--hairline); border-radius: 12px; padding:10px 12px; box-shadow: var(--shadow-1);
      min-width: 220px;
    }
    .toast.success{ border-color: var(--good-bd) }
    .toast.error{ border-color: var(--bad-bd) }

    /* Respect motion */
    @media (prefers-reduced-motion: reduce){ *{transition:none !important; animation:none !important} }
  </style>
</head>
<body class="theme-dentakay">
  <div class="wrap">
    <h2>Card Grading Profit & EV Calculator</h2>

    <!-- Top bar -->
    <div class="card compact">
      <div class="topbar">
        <div class="group" id="themeChips">
          <span class="muted">Theme</span>
          <button class="theme-chip" data-theme="dentakay" aria-pressed="true">Dentakay</button>
          <button class="theme-chip" data-theme="logofolio" aria-pressed="false">Logofolio</button>
          <button class="theme-chip" data-theme="forest" aria-pressed="false">Forest</button>
          <button class="theme-chip" data-theme="nissan" aria-pressed="false">Nissan</button>
        </div>

        <!-- Inline sign-in -->
        <div class="group email-wrap" id="signinInline">
          <input id="email" type="email" inputmode="email" autocomplete="email" placeholder="you@example.com"/>
          <button id="sendLink">Send link</button>
          <span id="sendStatus" class="muted"></span>
        </div>

        <!-- Mini Auth (signed in) -->
        <div class="group mini-auth hidden" id="authed">
          <span class="email-chip" id="emailChip" title=""><span class="dot"></span><span id="whoShort"></span></span>
          <button id="signOut" class="btn-secondary" title="Sign out">â†¥</button>
        </div>
      </div>

      <!-- Email link finish (if opened from email) -->
      <div id="step-complete" class="hidden" style="margin-top:6px">
        <div id="needEmail" class="hidden row">
          <input id="confirmEmail" type="email" inputmode="email" autocomplete="email" placeholder="confirm your email" style="width:220px"/>
          <button id="finishWithEmail">Finish</button>
          <span id="finishStatus" class="muted"></span>
        </div>
      </div>
    </div>

    <!-- App hidden until auth -->
    <div id="app" class="hidden">
      <div class="card">
        <div class="grid">
          <div><label>Card Name</label><input id="cardName" placeholder="e.g., 1991 SkyBox #546 MJ"/></div>
          <div><label>Raw Price ($)</label><input id="rawPrice" type="number" inputmode="decimal" value="20"/></div>
          <div><label>Grading Fee ($)</label><input id="gradingFee" type="number" inputmode="decimal" value="21"/></div>
          <div><label>PSA 9 Price ($)</label><input id="psa9Price" type="number" inputmode="decimal" value="25"/></div>
          <div><label>PSA 10 Price ($)</label><input id="psa10Price" type="number" inputmode="decimal" value="100"/></div>
          <div><label>eBay Fee (%)</label><input id="ebayFee" type="number" inputmode="decimal" value="12.5"/></div>
          <div><label>Gem Rate (%)</label><input id="gemRate" type="number" inputmode="decimal" value="60"/></div>
          <div>
            <label>Sport</label>
            <select id="sport">
              <option value="">â€” Select â€”</option>
              <option value="football">Football</option>
              <option value="basketball">Basketball</option>
              <option value="baseball">Baseball</option>
              <option value="hockey">Hockey</option>
              <option value="tennis">Tennis</option>
              <option value="non-sport">Non-Sport</option>
            </select>
          </div>
        </div>
        <div class="btns">
          <button id="calcBtn">Calculate</button>
          <button id="saveBtn">Save Card to Firebase</button>
          <button id="updateBtn" class="btn-secondary" style="display:none">Update Card</button>
          <button id="cancelEditBtn" class="btn-secondary" style="display:none">Cancel Edit</button>
          <span id="calcStatus" class="muted" style="min-height:20px"></span>
        </div>
        <div id="results" style="margin-top:8px;display:none">
          <div class="stat"><span>Total Cost (Raw + Grading)</span><b id="r_cost"></b></div>
          <div class="stat"><span>PSA 9 Net (after fees)</span><span><b id="r_net9"></b> <span id="r_pill9" class="pill"></span></span></div>
          <div class="stat"><span>PSA 10 Net (after fees)</span><span><b id="r_net10"></b> <span id="r_pill10" class="pill"></span></span></div>
          <div class="stat"><span>PSA 9 Profit/Loss</span><span id="r_p9"></span></div>
          <div class="stat"><span>PSA 10 Profit/Loss</span><span id="r_p10"></span></div>
          <div class="stat"><span>Expected Profit (Gem% Ã— P10 + (1âˆ’Gem%) Ã— P9)</span><span id="r_ev"></span></div>
          <div class="stat"><span>Decision</span><b id="r_decision" class="pill"></b></div>
          <div class="muted">Decision rule: <b>YES</b> if Gem Rate â‰¥ 60% and EV â‰¥ $0.</div>
        </div>
      </div>

      <!-- Filters/Search (sticky) -->
      <div class="card sticky">
        <div class="row" style="gap:16px;">
          <div style="min-width:160px;flex:1 1 220px">
            <label>Filter by Sport</label>
            <select id="filterSport">
              <option value="all">All</option>
              <option value="football">Football</option>
              <option value="basketball">Basketball</option>
              <option value="baseball">Baseball</option>
              <option value="hockey">Hockey</option>
              <option value="tennis">Tennis</option>
              <option value="non-sport">Non-Sport</option>
              <option value="none">No sport set</option>
            </select>
          </div>
          <div style="min-width:200px;flex:1 1 260px">
            <label>Sort</label>
            <select id="sortMode">
              <option value="created_desc">Created (newest â†’ oldest)</option>
              <option value="created_asc">Created (oldest â†’ newest)</option>
              <option value="year_asc">Year â†‘</option>
              <option value="year_desc">Year â†“</option>
              <option value="name_asc">Name A â†’ Z</option>
              <option value="name_desc">Name Z â†’ A</option>
            </select>
          </div>
          <div style="min-width:220px;flex:2 1 340px">
            <label>Search by Card Name</label>
            <input id="searchName" type="text" placeholder="Type to filter by nameâ€¦ (e.g., Jordan, 1991, SkyBox)"/>
          </div>
        </div>
      </div>

      <!-- Table / List -->
      <div class="card">
        <h3 style="margin:4px 0 8px">Saved Cards (Live)</h3>
        <div class="table-wrap">
          <table>
            <thead><tr>
              <th>Card</th><th>Year</th><th>Sport</th><th>Raw</th><th>9</th><th>10</th><th>Gem%</th><th>EV</th><th>Decision</th><th>Actions</th>
            </tr></thead>
            <tbody id="cardsTbody"></tbody>
          </table>
        </div>
        <div id="emptyState" class="muted hidden" style="margin-top:8px">No cards yet â€” add one above to get started.</div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      initializeAuth, onAuthStateChanged, signOut, setPersistence,
      browserLocalPersistence, browserPopupRedirectResolver,
      isSignInWithEmailLink, sendSignInLinkToEmail, signInWithEmailLink
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp, onSnapshot,
      query, orderBy, doc, deleteDoc, updateDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBvUBx-QTjTyzv8oWxoCX4rweq72yChS3M",
      authDomain: "grading-calculator-ce36f.firebaseapp.com",
      projectId: "grading-calculator-ce36f",
      messagingSenderId: "406763572625",
      appId: "1:406763572625:web:026a965c194d9a3c8cde30"
    };
    const app = initializeApp(firebaseConfig);
    const auth = initializeAuth(app, { persistence: browserLocalPersistence, popupRedirectResolver: browserPopupRedirectResolver });
    const db = getFirestore(app);

    // Helpers
    const $ = id => document.getElementById(id);
    const money = v => "$"+(Number(v)||0).toFixed(2);
    const show = (id, yes=true)=> $(id).classList.toggle("hidden", !yes);
    const pill = (el, ok)=>{ el.className = "pill "+(ok?"good":"bad"); el.textContent = ok?"PROFIT":"LOSS"; };
    let editingId=null, userCardsRef=null, unsubList=null, cacheDocs=[], firstLoaded=false;

    function getYearFromName(name){ if(!name) return null; const m=String(name).trim().match(/^(\d{4})/); return m?parseInt(m[1],10):null; }

    // Toasts
    function toast(msg, type="success", timeout=1800){
      const wrap = $("toastWrap");
      const el = document.createElement("div");
      el.className = "toast " + type;
      el.textContent = msg;
      wrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(-8px)"; el.style.transition="opacity .3s, transform .3s"; }, timeout);
      setTimeout(()=>{ wrap.removeChild(el); }, timeout+350);
    }

    // Theme
    const THEMES = ["dentakay","logofolio","forest","nissan"];
    function applyTheme(key){
      document.body.className = document.body.className.replace(/\btheme-\\w+\\b/g,'').trim();
      const cls = {dentakay:"theme-dentakay",logofolio:"theme-logofolio",forest:"theme-forest",nissan:"theme-nissan"}[key] || "";
      if (cls) document.body.classList.add(cls);
      localStorage.setItem("gc_theme", key);
      // update chip selection
      document.querySelectorAll('#themeChips .theme-chip').forEach(x=>x.setAttribute('aria-pressed','false'));
      const btn = document.querySelector(`#themeChips .theme-chip[data-theme="${key}"]`);
      if (btn) btn.setAttribute('aria-pressed','true');
    }
    (function initTheme(){
      const saved = localStorage.getItem("gc_theme") || "dentakay";
      applyTheme(saved);
      document.querySelectorAll('#themeChips .theme-chip').forEach(b=>{
        b.addEventListener('click', ()=>applyTheme(b.dataset.theme));
      });
    })();

    // Email link auth
    const actionCodeSettings = { url: `${window.location.origin}${window.location.pathname}`, handleCodeInApp: true };
    $("sendLink").addEventListener("click", async () => {
      const email = $("email").value.trim(); $("sendStatus").textContent="";
      if (!email){ $("sendStatus").textContent="Enter a valid email."; return; }
      try{
        await setPersistence(auth, browserLocalPersistence);
        await sendSignInLinkToEmail(auth, email, actionCodeSettings);
        localStorage.setItem("emailForSignIn", email);
        $("sendStatus").textContent="Link sent!";
        toast("Magic link sent.", "success");
      }catch(err){ console.error(err); $("sendStatus").textContent = err.message || "Could not send link."; toast("Could not send link.", "error"); }
    });

    function shortenEmail(email){
      if (!email) return "";
      const [name, domain] = email.split("@");
      if (!domain) return email;
      return (name.length <= 3 ? name : name.slice(0,3) + "â€¦") + "@" + domain;
    }

    async function finishSignIn(email){
      const finishStatus = $("finishStatus"); if (finishStatus) finishStatus.textContent="Signing you inâ€¦";
      try{
        await setPersistence(auth, browserLocalPersistence);
        await signInWithEmailLink(auth, email, window.location.href);
        localStorage.removeItem("emailForSignIn");
        if (finishStatus) finishStatus.textContent="";
        history.replaceState({}, document.title, window.location.pathname);
        toast("Signed in", "success");
      }catch(err){ console.error(err); if (finishStatus) finishStatus.textContent = err.message || "Could not complete sign-in."; toast("Sign-in failed", "error"); }
    }

    (async () => {
      if (isSignInWithEmailLink(auth, window.location.href)){
        show("step-complete", true);
        const email = localStorage.getItem("emailForSignIn");
        if (email){ await finishSignIn(email); }
        else{
          show("needEmail", true);
          $("finishWithEmail").addEventListener("click", async ()=>{
            const em = $("confirmEmail").value.trim();
            if (!em){ $("finishStatus").textContent="Enter your email."; return; }
            await finishSignIn(em);
          });
        }
      }
    })();

    onAuthStateChanged(auth, (user)=>{
      if (user){
        show("authed", true); show("signinInline", false); show("app", true);
        $("emailChip").title = user.email || user.uid;
        $("whoShort").textContent = shortenEmail(user.email || user.uid);
        userCardsRef = collection(db, `users/${user.uid}/cards`);
        if (unsubList) unsubList();
        unsubList = onSnapshot(query(userCardsRef, orderBy("createdAt","desc")), (snap)=>{
          cacheDocs = []; snap.forEach(d=>{ const data=d.data(); cacheDocs.push({ id:d.id, ...data, __createdAt: data.createdAt?.toMillis?.() || 0 }); });
          firstLoaded = true;
          renderFilteredSorted();
        });
      }else{
        show("authed", false); show("signinInline", true); show("app", false);
        if (unsubList){ unsubList(); unsubList=null; }
        cacheDocs=[]; $("cardsTbody").innerHTML=""; firstLoaded = false;
      }
    });
    $("signOut").addEventListener("click", async ()=>{ try{ await signOut(auth); toast("Signed out","success"); }catch(e){ console.error(e); toast("Sign-out failed","error"); } });

    // Calculator
    function calc(){
      const raw = parseFloat($("rawPrice").value)||0;
      const grade = parseFloat($("gradingFee").value)||0;
      const p9 = parseFloat($("psa9Price").value)||0;
      const p10 = parseFloat($("psa10Price").value)||0;
      const fee = (parseFloat($("ebayFee").value)||0)/100;
      const gem = (parseFloat($("gemRate").value)||0)/100;
      const cost = raw + grade, net9 = p9*(1-fee), net10 = p10*(1-fee);
      const profit9 = net9 - cost, profit10 = net10 - cost;
      const ev = gem*profit10 + (1-gem)*profit9;
      const pass = gem >= 0.60 && ev >= 0;
      $("results").style.display="block";
      $("r_cost").textContent=money(cost); $("r_net9").textContent=money(net9); $("r_net10").textContent=money(net10);
      const r_pill9 = document.getElementById("r_pill9"), r_pill10 = document.getElementById("r_pill10");
      if (r_pill9) { pill(r_pill9, profit9>=0); }
      if (r_pill10){ pill(r_pill10, profit10>=0); }
      $("r_p9").innerHTML=(profit9>=0?'<span class="pill good">+</span> ':'<span class="pill bad">âˆ’</span> ')+money(Math.abs(profit9));
      $("r_p10").innerHTML=(profit10>=0?'<span class="pill good">+</span> ':'<span class="pill bad">âˆ’</span> ')+money(Math.abs(profit10));
      $("r_ev").innerHTML=(ev>=0?'<span class="pill good">+</span> ':'<span class="pill bad">âˆ’</span> ')+money(Math.abs(ev));
      const r_dec = document.getElementById("r_decision");
      if (r_dec){ r_dec.className="pill "+(pass?"good":"bad"); r_dec.textContent=pass?"YES (Grade)":"NO (Skip)"; }
      return { raw, grade, p9, p10, feePct:fee, gemPct:gem, cost, net9, net10, profit9, profit10, ev, pass };
    }
    $("calcBtn").addEventListener("click", ()=>{ calc(); toast("Calculated","success"); });

    // Save/Update
    $("saveBtn").addEventListener("click", async ()=>{
      const u=auth.currentUser; if(!u){ alert("Sign in first."); return; }
      const name=$("cardName").value.trim(); if(!name){ alert("Please enter a Card Name."); return; }
      const sport = $("sport").value || "";
      const r = calc();
      try{
        await addDoc(userCardsRef,{ name,sport, raw:r.raw,gradingFee:r.grade,psa9:r.p9,psa10:r.p10, ebayFeePct:r.feePct,gemRatePct:r.gemPct, cost:r.cost,net9:r.net9,net10:r.net10, profit9:r.profit9,profit10:r.profit10, ev:r.ev, decision:r.pass?"YES":"NO", createdAt: serverTimestamp() });
        toast("Saved card","success"); clearEditing();
      }catch(e){ console.error(e); toast("Save failed","error"); }
    });
    $("updateBtn").addEventListener("click", updateExisting);
    $("cancelEditBtn").addEventListener("click", clearEditing);
    async function updateExisting(){
      const u=auth.currentUser; if(!u || !editingId) return;
      const r=calc(); const name=$("cardName").value.trim(); const sport=$("sport").value || "";
      try{
        await updateDoc(doc(db,`users/${u.uid}/cards/${editingId}`),{ name,sport, raw:r.raw,gradingFee:r.grade,psa9:r.p9,psa10:r.p10, ebayFeePct:r.feePct,gemRatePct:r.gemPct, cost:r.cost,net9:r.net9,net10:r.net10, profit9:r.profit9,profit10:r.profit10, ev:r.ev, decision:r.pass?"YES":"NO" });
        toast("Updated card","success"); clearEditing();
      }catch(e){ console.error(e); toast("Update failed","error"); }
    }
    function enterEdit(docId,data){
      editingId=docId;
      $("cardName").value=data.name||"";
      $("sport").value=data.sport||"";
      $("rawPrice").value=data.raw??"";
      $("gradingFee").value=data.gradingFee??"";
      $("psa9Price").value=data.psa9??"";
      $("psa10Price").value=data.psa10??"";
      $("ebayFee").value=data.ebayFeePct ? (data.ebayFeePct*100).toFixed(2) : "12.5";
      $("gemRate").value=data.gemRatePct ? (data.gemRatePct*100).toFixed(0) : "60";
      calc();
      $("saveBtn").style.display="inline-block";
      $("updateBtn").style.display="inline-block";
      $("cancelEditBtn").style.display="inline-block";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
    function clearEditing(){ editingId=null; $("saveBtn").style.display="inline-block"; $("updateBtn").style.display="none"; $("cancelEditBtn").style.display="none"; }

    // List / Filters / Search
    const tbody=$("cardsTbody"), filterSportSel=$("filterSport"), sortModeSel=$("sortMode"), searchName=$("searchName");
    filterSportSel.addEventListener("change", renderFilteredSorted);
    sortModeSel.addEventListener("change", renderFilteredSorted);
    searchName.addEventListener("input", renderFilteredSorted);

    // Skeleton rows before first snapshot
    function renderSkeleton(){
      const rows = 3;
      tbody.innerHTML = "";
      for(let i=0;i<rows;i++){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="10">
          <div class="skeleton"><div class="shimmer"></div></div>
        </td>`;
        tbody.appendChild(tr);
      }
      show("emptyState", false);
    }

    function sportLabel(v){ if(!v) return "â€”"; const map={football:"Football",basketball:"Basketball",baseball:"Baseball",hockey:"Hockey",tennis:"Tennis","non-sport":"Non-Sport"}; return map[v]||v; }

    function renderFilteredSorted(){
      if (!firstLoaded){ renderSkeleton(); return; }
      let rows = cacheDocs.slice();
      const f = filterSportSel.value;
      if (f && f !== "all"){ rows = (f==="none") ? rows.filter(x=>!x.sport) : rows.filter(x=>(x.sport||"")===f); }
      const q = searchName.value.trim().toLowerCase(); if (q) rows = rows.filter(x=>String(x.name||"").toLowerCase().includes(q));
      const mode = sortModeSel.value;
      rows.sort((a,b)=>{
        if (mode==="created_desc") return b.__createdAt - a.__createdAt;
        if (mode==="created_asc") return a.__createdAt - b.__createdAt;
        if (mode==="name_asc") return String(a.name||"").localeCompare(String(b.name||""));
        if (mode==="name_desc") return String(b.name||"").localeCompare(String(a.name||""));
        if (mode==="year_asc" || mode==="year_desc"){
          const ya=getYearFromName(a.name), yb=getYearFromName(b.name);
          const ca=(ya??-Infinity), cb=(yb??-Infinity);
          return mode==="year_asc" ? (ca-cb) : (cb-ca);
        }
        return 0;
      });

      tbody.innerHTML="";
      if (rows.length === 0){
        show("emptyState", true);
        return;
      }
      show("emptyState", false);

      rows.forEach(c=>{
        const tr=document.createElement("tr");
        const year=getYearFromName(c.name);
        tr.innerHTML=`<td>${c.name||""}</td><td>${year??"â€”"}</td><td>${sportLabel(c.sport)}</td>
          <td>${money(c.raw)}</td><td>${money(c.psa9)}</td><td>${money(c.psa10)}</td>
          <td>${Math.round((c.gemRatePct||0)*100)}%</td><td>${money(c.ev||0)}</td>
          <td><span class="pill ${c.decision==='YES'?'good':'bad'}">${c.decision||'NO'}</span></td>
          <td class="actions">
            <button class="btn-secondary" data-action="edit" data-id="${c.id}" title="Edit">âœŽ</button>
            <button class="btn-danger" data-action="delete" data-id="${c.id}" title="Delete">ðŸ—‘</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    // Delegated actions
    tbody.addEventListener("click", async (e) => {
      const btn = e.target.closest("button"); if (!btn) return;
      const id = btn.getAttribute("data-id"); const action = btn.getAttribute("data-action");
      const u = auth.currentUser; if (!u || !id || !action) return;
      if (action === "delete"){
        if (!confirm("Delete this card?")) return;
        try{ await deleteDoc(doc(db, `users/${u.uid}/cards/${id}`)); toast("Deleted card","success"); }
        catch(err){ console.error(err); toast("Delete failed","error"); }
      } else if (action === "edit"){
        try{ const snap = await getDoc(doc(db, `users/${u.uid}/cards/${id}`)); if (snap.exists()) enterEdit(id, snap.data()); }
        catch(err){ console.error(err); toast("Load failed","error"); }
      }
    });

    // Init
    window.addEventListener("DOMContentLoaded", ()=>{
      // Theme
      applyTheme(localStorage.getItem("gc_theme")||"dentakay");
      // Pre-render skeleton
      renderSkeleton();
    });
  </script>
</body>
</html>
