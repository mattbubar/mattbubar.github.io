<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Card Grading Calculator</title>

  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg:#0f172a; --card:#0b1220; --muted:#94a3b8; --text:#e5e7eb;
      --blue:#2563eb; --green:#16a34a; --red:#dc2626; --border:rgba(255,255,255,.08)
    }
    *{box-sizing:border-box}
    html{font-size:16px}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-tap-highlight-color: transparent;
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .hero{ text-align:center; margin:8px 0 16px; }
    .hero img{ max-width:200px; height:auto; display:block; margin:0 auto 8px; }
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:14px; padding:16px; margin-bottom:16px
    }
    .authbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center}
    .muted{color:var(--muted)}
    .hidden{display:none !important}

    label{display:block;font-size:.8rem;color:var(--muted);margin:6px 0 4px}
    input{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border);
      background:#0a0f1e; color:var(--text); font-size:1rem; touch-action:manipulation;
    }
    input[type="number"]{appearance:textfield}
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button{appearance:none;margin:0}

    button{
      width:100%; padding:14px; border:0; border-radius:12px; cursor:pointer;
      background:var(--blue); color:#fff; font-weight:700; font-size:1rem;
    }
    .btns{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    .btn-secondary{background:#334155}
    .btn-danger{background:#dc2626}

    .grid{display:grid;gap:10px;grid-template-columns:1fr}
    @media (min-width:760px){ .grid{grid-template-columns:repeat(3,1fr)} .btns{grid-template-columns:repeat(3,1fr)} }

    .stat{
      display:flex;justify-content:space-between;gap:10px;
      padding:12px;border:1px solid var(--border);border-radius:12px;background:#0a0f1e;margin-top:8px;
      font-size:1rem
    }
    .pill{padding:2px 10px;border-radius:999px;font-size:.78rem;font-weight:800}
    .good{background:rgba(22,163,74,.15);color:#86efac;border:1px solid rgba(22,163,74,.3)}
    .bad{background:rgba(220,38,38,.15);color:#fecaca;border:1px solid rgba(220,38,38,.3)}
    .small{font-size:.85rem;color:var(--muted)}

    .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
    table{width:100%;border-collapse:collapse;min-width:680px}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left;font-size:.95rem;white-space:nowrap;vertical-align:middle}
    th{color:var(--muted);font-weight:700}
    .actions{display:flex;gap:8px}

    /* debug bar (optional) */
    #debug{white-space:pre-wrap;font:12px/1.45 ui-monospace,Menlo,monospace;background:#111827;color:#e5e7eb;border:1px solid #334155;border-radius:10px;padding:10px;margin:16px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <img src="logo.png" alt="Card Grading Calculator">
      <h1 style="margin:0;font-size:1.35rem;">Card Grading Calculator</h1>
    </div>

    <div class="card authbar">
      <div id="userInfo" class="muted">Not signed in</div>
      <button id="signInBtn" style="max-width:260px">Sign in with Google</button>
      <button id="signOutBtn" class="btn-secondary hidden" style="max-width:160px">Sign out</button>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Profit & EV Calculator</h3>
      <div class="grid">
        <div><label>Card Name</label><input id="cardName" placeholder="e.g., 1991 SkyBox #546 MJ"></div>
        <div><label>Raw Price ($)</label><input id="rawPrice" type="number" inputmode="decimal" step="0.01" value="20"></div>
        <div><label>Grading Fee ($)</label><input id="gradingFee" type="number" inputmode="decimal" step="0.01" value="21"></div>
        <div><label>PSA 9 Price ($)</label><input id="psa9Price" type="number" inputmode="decimal" step="0.01" value="25"></div>
        <div><label>PSA 10 Price ($)</label><input id="psa10Price" type="number" inputmode="decimal" step="0.01" value="100"></div>
        <div><label>eBay Fee (%)</label><input id="ebayFee" type="number" inputmode="decimal" step="0.1" value="12.5"></div>
        <div><label>Gem Rate (%)</label><input id="gemRate" type="number" inputmode="decimal" step="1" value="60"></div>
      </div>

      <div class="btns">
        <button id="calcBtn">Calculate</button>
        <button id="saveBtn" class="hidden">Save Card</button>
        <button id="updateBtn" class="btn-secondary hidden">Update Card</button>
        <button id="cancelEditBtn" class="btn-secondary hidden">Cancel Edit</button>
      </div>

      <div id="results" style="margin-top:8px;display:none">
        <div class="stat"><span>Total Cost (Raw + Grading)</span><b id="r_cost"></b></div>
        <div class="stat"><span>PSA 9 Net (after fees)</span><span><b id="r_net9"></b> <span id="r_pill9" class="pill"></span></span></div>
        <div class="stat"><span>PSA 10 Net (after fees)</span><span><b id="r_net10"></b> <span id="r_pill10" class="pill"></span></span></div>
        <div class="stat"><span>PSA 9 Profit/Loss</span><span id="r_p9"></span></div>
        <div class="stat"><span>PSA 10 Profit/Loss</span><span id="r_p10"></span></div>
        <div class="stat"><span>Expected Profit (Gem% × P10 + (1−Gem%) × P9)</span><span id="r_ev"></span></div>
        <div class="stat"><span>Decision</span><b id="r_decision" class="pill"></b></div>
        <div class="small">Decision rule: <b>YES</b> if Gem Rate ≥ 60% and EV ≥ $0.</div>
      </div>
      <div class="small">Sign in to save, edit, and delete your cards (private to your account).</div>
    </div>

    <div class="card">
      <h3 style="margin:4px 0 8px">Saved Cards (Live)</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Card</th><th>Raw</th><th>9</th><th>10</th><th>Gem%</th><th>EV</th><th>Decision</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="cardsTbody"><tr><td colspan="8" class="small">Sign in to see your saved cards.</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Debug panel (optional, helps on mobile) -->
    <div id="debug"><b>Debug</b></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, serverTimestamp, onSnapshot, 
      query, orderBy, doc, deleteDoc, updateDoc 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signInWithPopup, signInWithRedirect,
      GoogleAuthProvider, signOut, getRedirectResult,
      setPersistence, browserLocalPersistence, browserSessionPersistence, inMemoryPersistence
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // --- Debug helper ---
    const dbg = (msg, data) => {
      const el = document.getElementById('debug');
      if (!el) return;
      const line = `[${new Date().toLocaleTimeString()}] ${msg} ${data ? JSON.stringify(data) : ""}`;
      el.textContent += (el.textContent ? "\n" : "") + line;
      console.log(line);
    };

    // Firebase config (yours)
    const firebaseConfig = {
      apiKey: "AIzaSyBvUBx-QTjTyzv8oWxoCX4rweq72yChS3M",
      authDomain: "grading-calculator-ce36f.firebaseapp.com",
      projectId: "grading-calculator-ce36f",
      storageBucket: "grading-calculator-ce36f.firebasestorage.app",
      messagingSenderId: "406763572625",
      appId: "1:406763572625:web:026a965c194d9a3c8cde30",
      measurementId: "G-GRKKZPC8VV"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);
    auth.useDeviceLanguage?.();

    // ---- Environment detection ----
    const ua = navigator.userAgent || navigator.vendor || "";
    const isIOS = /iPhone|iPad|iPod/.test(ua);
    const isAndroid = /Android/i.test(ua);
    const isMobile = isIOS || isAndroid;

    // common in-app browsers (break auth)
    const isFacebook = ua.includes("FBAN") || ua.includes("FBAV");
    const isInstagram = ua.includes("Instagram");
    const isTwitter   = ua.includes("Twitter");
    const isTikTok    = ua.toLowerCase().includes("tiktok");
    const isGSA       = ua.includes("GSA"); // Google app on iOS
    const isInAppBrowser = isFacebook || isInstagram || isTwitter || isTikTok || isGSA;

    // Show an "Open in Safari/Chrome" banner if in-app
    if (isInAppBrowser) {
      const bar = document.createElement("div");
      bar.style.cssText = "position:sticky;top:0;z-index:9999;background:#581c87;color:#fff;padding:10px;border-radius:10px;margin:10px 0;text-align:center;font-weight:700";
      bar.innerHTML = `This app works best in Safari/Chrome. <button id="openExternal" style="margin-left:8px;padding:8px 12px;border:0;border-radius:8px;background:#10b981;color:#fff;font-weight:800">Open in browser</button>`;
      document.querySelector(".wrap").prepend(bar);
      document.getElementById("openExternal").onclick = () => {
        // user-gesture required: open same URL in external browser (most apps show an "open in Safari" option)
        window.open(location.href, "_blank", "noopener,noreferrer");
      };
      dbg("inAppBrowser", true);
    }

    // Log origin & authDomain
    dbg("origin", location.origin);
    dbg("authDomain", auth.config?.authDomain || "(none)");

    // ---- Force persistence with fallbacks ----
    try {
      await setPersistence(auth, browserLocalPersistence);
      dbg("persistence", "local");
    } catch {
      try {
        await setPersistence(auth, browserSessionPersistence);
        dbg("persistence", "session");
      } catch {
        await setPersistence(auth, inMemoryPersistence);
        dbg("persistence", "inMemory");
      }
    }

	// --- storage/cookie diagnostics (iOS Safari troubleshooter) ---
	try { localStorage.setItem('_t','1'); localStorage.removeItem('_t'); dbg('localStorage','ok'); } catch(e){ dbg('localStorage','blocked'); }
	try { sessionStorage.setItem('_t','1'); sessionStorage.removeItem('_t'); dbg('sessionStorage','ok'); } catch(e){ dbg('sessionStorage','blocked'); }
	// test first-party cookie (requires https)
	document.cookie = "t=1; path=/; SameSite=Lax; Secure";
	dbg('cookie', document.cookie.includes('t=1') ? 'ok' : 'blocked');

    // ---- UI helpers ----
    const $ = id => document.getElementById(id);
    const money = v => "$" + (Number(v)||0).toFixed(2);
    const pill = (el, ok) => { el.className = "pill " + (ok ? "good" : "bad"); el.textContent = ok ? "PROFIT" : "LOSS"; };

    // ---- Calculator ----
    function calc() {
      const raw = parseFloat($("rawPrice").value)||0;
      const grade = parseFloat($("gradingFee").value)||0;
      const p9 = parseFloat($("psa9Price").value)||0;
      const p10 = parseFloat($("psa10Price").value)||0;
      const fee = (parseFloat($("ebayFee").value)||0)/100;
      const gem = (parseFloat($("gemRate").value)||0)/100;

      const cost = raw + grade;
      const net9 = p9 * (1 - fee);
      const net10 = p10 * (1 - fee);
      const profit9 = net9 - cost;
      const profit10 = net10 - cost;
      const ev = gem * profit10 + (1 - gem) * profit9;
      const pass = gem >= 0.60 && ev >= 0;

      $("results").style.display = "block";
      $("r_cost").textContent = money(cost);
      $("r_net9").textContent = money(net9);
      $("r_net10").textContent = money(net10);
      pill($("r_pill9"), profit9 >= 0);
      pill($("r_pill10"), profit10 >= 0);
      $("r_p9").innerHTML = (profit9>=0?'<span class="pill good">+</span> ':'<span class="pill bad">−</span> ')+ money(Math.abs(profit9));
      $("r_p10").innerHTML = (profit10>=0?'<span class="pill good">+</span> ':'<span class="pill bad">−</span> ')+ money(Math.abs(profit10));
      $("r_ev").innerHTML = (ev>=0?'<span class="pill good">+</span> ':'<span class="pill bad">−</span> ')+ money(Math.abs(ev));
      $("r_decision").className = "pill " + (pass ? "good" : "bad");
      $("r_decision").textContent = pass ? "YES (Grade)" : "NO (Skip)";
      return { raw, grade, p9, p10, feePct: fee, gemPct: gem, cost, net9, net10, profit9, profit10, ev, pass };
    }
    $("calcBtn").addEventListener("click", calc);

    // ---- Firestore save/update/delete ----
    let unsubscribe = null, currentUid = null, editingId = null;
    const cache = new Map();

    async function saveNew() {
      if (!currentUid) { alert("Please sign in first."); return; }
      const name = $("cardName").value.trim();
      if (!name) { alert("Please enter a Card Name."); return; }
      const r = calc();
      await addDoc(collection(db, `users/${currentUid}/cards`), {
        name,
        raw: r.raw, gradingFee: r.grade, psa9: r.p9, psa10: r.p10,
        ebayFeePct: r.feePct, gemRatePct: r.gemPct,
        cost: r.cost, net9: r.net9, net10: r.net10,
        profit9: r.profit9, profit10: r.profit10, ev: r.ev,
        decision: r.pass ? "YES" : "NO",
        createdAt: serverTimestamp()
      })
      .then(() => alert("Saved ✅"))
      .catch(e => {
        dbg("firestore add error", { code: e?.code, message: e?.message });
        alert("Save error: " + (e.message || e.code || e));
      });
      editingId = null;
      $("saveBtn").classList.remove("hidden");
      $("updateBtn").classList.add("hidden");
      $("cancelEditBtn").classList.add("hidden");
    }
    $("saveBtn").addEventListener("click", saveNew);

    async function updateExisting() {
      if (!editingId || !currentUid) return;
      const name = $("cardName").value.trim();
      const r = calc();
      await updateDoc(doc(db, `users/${currentUid}/cards`, editingId), {
        name,
        raw: r.raw, gradingFee: r.grade, psa9: r.p9, psa10: r.p10,
        ebayFeePct: r.feePct, gemRatePct: r.gemPct,
        cost: r.cost, net9: r.net9, net10: r.net10,
        profit9: r.profit9, profit10: r.profit10, ev: r.ev,
        decision: r.pass ? "YES" : "NO",
      })
      .then(() => alert("Updated ✅"))
      .catch(e => {
        dbg("firestore update error", { code: e?.code, message: e?.message });
        alert("Update error: " + (e.message || e.code || e));
      });
      editingId = null;
      $("saveBtn").classList.remove("hidden");
      $("updateBtn").classList.add("hidden");
      $("cancelEditBtn").classList.add("hidden");
    }
    $("updateBtn").addEventListener("click", updateExisting);
    $("cancelEditBtn").addEventListener("click", () => {
      editingId = null;
      $("saveBtn").classList.remove("hidden");
      $("updateBtn").classList.add("hidden");
      $("cancelEditBtn").classList.add("hidden");
    });

    function enterEdit(id, data) {
      editingId = id;
      $("cardName").value = data.name || "";
      $("rawPrice").value = data.raw ?? "";
      $("gradingFee").value = data.gradingFee ?? "";
      $("psa9Price").value = data.psa9 ?? "";
      $("psa10Price").value = data.psa10 ?? "";
      $("ebayFee").value = data.ebayFeePct ? (data.ebayFeePct*100).toFixed(2) : "12.5";
      $("gemRate").value = data.gemRatePct ? (data.gemRatePct*100).toFixed(0) : "60";
      calc();
      $("saveBtn").classList.add("hidden");
      $("updateBtn").classList.remove("hidden");
      $("cancelEditBtn").classList.remove("hidden");
    }

    function startUserListener(uid) {
      const q = query(collection(db, `users/${uid}/cards`), orderBy("createdAt","desc"));
      unsubscribe = onSnapshot(
        q,
        (snap) => {
          const tbody = $("cardsTbody");
          tbody.innerHTML = "";
          cache.clear();
          snap.forEach(docSnap => {
            const c = docSnap.data(); cache.set(docSnap.id, c);
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${c.name || ""}</td>
              <td>${money(c.raw)}</td>
              <td>${money(c.psa9)}</td>
              <td>${money(c.psa10)}</td>
              <td>${Math.round((c.gemRatePct||0)*100)}%</td>
              <td>${money(c.ev || 0)}</td>
              <td><span class="pill ${c.decision==='YES'?'good':'bad'}">${c.decision||'NO'}</span></td>
              <td class="actions">
                <button class="btn-secondary" data-action="edit" data-id="${docSnap.id}">Edit</button>
                <button class="btn-danger" data-action="delete" data-id="${docSnap.id}">Delete</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
          if (!snap.size) {
            $("cardsTbody").innerHTML = `<tr><td colspan="8" class="small">No cards saved yet.</td></tr>`;
          }
        },
        (e) => {
          dbg("snapshot error", { code: e?.code, message: e?.message });
          alert("Live view error: " + (e.message || e.code || e));
        }
      );
    }

    $("cardsTbody").addEventListener("click", async (e) => {
      const btn = e.target.closest("button"); if (!btn) return;
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");
      if (action === "delete") {
        if (confirm("Delete this card?")) await deleteDoc(doc(db, `users/${currentUid}/cards`, id));
      } else if (action === "edit") {
        const data = cache.get(id); if (data) enterEdit(id, data);
      }
    });

    // ----- Auth: smart sign-in (popup with fallback; redirect on mobile) -----
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    async function signInSmart() {
      try {
        if (isMobile) {
          dbg("sign-in", { mode: "redirect", inApp: isInAppBrowser });
          await signInWithRedirect(auth, provider);
          return;
        }
        dbg("sign-in", { mode: "popup" });
        await signInWithPopup(auth, provider);
      } catch (e) {
        if (e?.code === 'auth/popup-closed-by-user' ||
            e?.code === 'auth/popup-blocked' ||
            e?.code === 'auth/cancelled-popup-request') {
          dbg("popup failed -> redirect", { code: e.code });
          await signInWithRedirect(auth, provider);
        } else {
          dbg("sign-in error", { code: e?.code, message: e?.message });
          alert(e.message || e.code || e);
        }
      }
    }

    document.getElementById("signInBtn").onclick = signInSmart;
    document.getElementById("signOutBtn").onclick = () => signOut(auth);

    // Process redirect result on load
    try {
      const res = await getRedirectResult(auth);
      if (res?.user) dbg("redirect result user", { uid: res.user.uid, email: res.user.email });
    } catch (e) {
      dbg("redirect error", { code: e?.code, message: e?.message });
    }

    onAuthStateChanged(auth, (user) => {
      dbg("auth state", { uid: user?.uid || null });
      if (unsubscribe) { unsubscribe(); unsubscribe = null; }

      if (!user) {
        currentUid = null;
        document.getElementById("userInfo").textContent = "Not signed in";
        document.getElementById("signInBtn").classList.remove("hidden");
        document.getElementById("signOutBtn").classList.add("hidden");
        document.getElementById("saveBtn").classList.add("hidden");
        document.getElementById("updateBtn").classList.add("hidden");
        document.getElementById("cancelEditBtn").classList.add("hidden");
        document.getElementById("cardsTbody").innerHTML =
          `<tr><td colspan="8" class="small">Sign in to see your saved cards.</td></tr>`;
        return;
      }

      // Signed in: force UI + start listener
      currentUid = user.uid;
      document.getElementById("userInfo").textContent =
        `Signed in as ${user.displayName || user.email || user.uid}`;
      document.getElementById("signInBtn").classList.add("hidden");
      document.getElementById("signOutBtn").classList.remove("hidden");
      document.getElementById("saveBtn").classList.remove("hidden");
      document.getElementById("updateBtn").classList.add("hidden");
      document.getElementById("cancelEditBtn").classList.add("hidden");

      startUserListener(currentUid);
    });

    // Initial calc
    window.addEventListener("DOMContentLoaded", calc);
  </script>
</body>
</html>
